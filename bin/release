#!/usr/bin/env node

var assign = require('object-assign');
var cwd = process.cwd();
var fs = require('fs');
var gat = require('gulp-auto-task');
var path = require('path');
var pkg = require(path.join(cwd, '/package.json'));
var semver = require('semver');
var sh = require('shelljs');

function replace (file, pattern, replacement) {
  var str = fs.readFileSync(file).toString();
  str = str.replace(pattern, replacement);
  fs.writeFileSync(file, str);
}

var opts = assign({
  type: 'patch'
}, gat.opts());
var currentVersion = pkg.version;
var nextVersion = opts.semver || semver.inc(
  currentVersion,
  opts.type
);

sh.exec('eslint');
sh.exec('test');
replace('bower.json', currentVersion, nextVersion);
replace('package.json', currentVersion, nextVersion);
sh.exec('bundle');
sh.exec('git add dist/');
sh.exec('git commit -am "' + currentVersion + ' -> ' + nextVersion + '"');
sh.exec('git tag -a ' + nextVersion + ' -m ' + nextVersion);
sh.exec('git push');
sh.exec('git push --tags');
sh.exec('npm publish');
